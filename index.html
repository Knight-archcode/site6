// Add this function to index.html (inside the script tag)

// Enhanced data loading with multiple fallbacks
function loadData() {
    console.log('Attempting to load hotel data...');
    
    // Try multiple data sources in order
    const sources = [
        { name: 'localStorage', data: localStorage.getItem('hotelHopperData') },
        { name: 'sessionStorage', data: sessionStorage.getItem('hotelHopperData') },
        { name: 'cookie', data: getCookie('hotelHopperData') }
    ];
    
    let loadedData = null;
    
    for (const source of sources) {
        if (source.data) {
            try {
                loadedData = JSON.parse(source.data);
                console.log(`Loaded data from ${source.name}`);
                break;
            } catch (e) {
                console.error(`Error parsing data from ${source.name}:`, e);
            }
        }
    }
    
    if (loadedData) {
        hotelData = loadedData;
        if (Object.keys(hotelData.floors).length > 0) {
            populateLocations();
            populateFloorSelector();
            setupDataSync();
            showNotification('Hotel data loaded successfully!', 'success');
            return;
        }
    }
    
    // Show error message if no data
    showDataNotFoundMessage();
}

// Get cookie value
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    return null;
}

// Setup data synchronization
function setupDataSync() {
    // Listen for localStorage changes
    window.addEventListener('storage', function(e) {
        if (e.key === 'hotelHopperData') {
            console.log('Storage event detected');
            handleDataUpdate(e.newValue);
        }
    });
    
    // Listen for BroadcastChannel messages
    if (typeof BroadcastChannel !== 'undefined') {
        try {
            const channel = new BroadcastChannel('hotel-hopper-data');
            channel.onmessage = function(event) {
                if (event.data.type === 'data-update') {
                    console.log('BroadcastChannel update received');
                    hotelData = event.data.data;
                    refreshUI();
                    showNotification('Data updated from admin panel', 'info');
                }
            };
        } catch (e) {
            console.log('BroadcastChannel not available');
        }
    }
    
    // Poll for updates every 2 seconds
    setInterval(checkForDataUpdates, 2000);
}

// Handle data updates
function handleDataUpdate(newData) {
    if (newData) {
        try {
            hotelData = JSON.parse(newData);
            refreshUI();
            showNotification('Data updated from admin panel', 'info');
        } catch (e) {
            console.error('Error updating data:', e);
        }
    }
}

// Refresh UI after data update
function refreshUI() {
    populateLocations();
    populateFloorSelector();
    if (currentFloorView) {
        renderMap();
    }
    if (currentRoute) {
        // Recalculate current route if exists
        const startVal = document.getElementById('startLocation').value;
        const endVal = document.getElementById('endLocation').value;
        if (startVal && endVal) {
            setTimeout(() => findRoute(), 100);
        }
    }
}

// Check for data updates
function checkForDataUpdates() {
    const currentData = localStorage.getItem('hotelHopperData');
    if (currentData) {
        try {
            const newData = JSON.parse(currentData);
            const newHash = JSON.stringify(newData);
            const oldHash = JSON.stringify(hotelData);
            
            if (newHash !== oldHash) {
                console.log('Data changed, updating...');
                hotelData = newData;
                refreshUI();
            }
        } catch (e) {
            console.error('Error checking for updates:', e);
        }
    }
}

// Show data not found message
function showDataNotFoundMessage() {
    const container = document.getElementById('mapContainer');
    container.innerHTML = `
        <div class="text-center py-16">
            <span class="text-6xl block mb-4">‚ö†Ô∏è</span>
            <p class="text-gray-600 text-lg mb-2">No hotel data found</p>
            <p class="text-gray-500 text-sm mb-6">Please set up the hotel navigation system using the admin panel first</p>
            <div class="space-y-3">
                <a href="admin.html" class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:opacity-90 transition-all font-semibold">
                    Go to Admin Panel
                </a>
                <p class="text-gray-400 text-xs">After setting up in admin, refresh this page</p>
                <button onclick="loadData()" class="inline-block px-4 py-2 bg-gray-600 text-white rounded-lg hover:opacity-90 transition-all text-sm">
                    üîÑ Try Loading Again
                </button>
            </div>
        </div>
    `;
}

// Initialize
window.onload = function() {
    console.log('Initializing Hotel Hopper...');
    loadData();
    loadRouteFromURL();
};
